<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Call</title>
  <style>
    body, html { margin:0; padding:0; height:100%; background:#000; position:relative; }
    video { position:absolute; width:100%; height:100%; object-fit:cover; }
    #localVideo {
      width:120px; height:160px;
      bottom:20px; right:20px;
      border:2px solid #fff; border-radius:10px;
      z-index:2; object-fit:cover; position:absolute;
    }
    #roomIdDisplay {
      position:absolute; top:20px; left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.5); color:#fff;
      padding:8px 12px; border-radius:12px;
      font-size:16px; z-index:3;
    }
    #endCall {
      position:absolute; bottom:30px; left:50%;
      transform:translateX(-50%);
      width:60px; height:60px; border-radius:50%;
      border:none; background:#e53935; color:#fff;
      font-size:24px; cursor:pointer; z-index:3;
    }
  </style>
</head>
<body>

<video id="remoteVideo" autoplay playsinline></video>
<video id="localVideo" autoplay playsinline muted></video>
<div id="roomIdDisplay"></div>
<button id="endCall">ðŸ“ž</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, onSnapshot, addDoc, collection, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const roomId = localStorage.getItem("roomId");
  if (!roomId) location.href = "index.html";
  document.getElementById("roomIdDisplay").textContent = `Room ID: ${roomId}`;

  const pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
  const localVideo = document.getElementById("localVideo");
  const remoteVideo = document.getElementById("remoteVideo");
  let localStream = null;
  let isCreator = false;

  async function startMedia() {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  }

  pc.ontrack = event => {
    // Attach the remote stream directly
    const [remoteStream] = event.streams;
    remoteVideo.srcObject = remoteStream;
  };

  pc.onicecandidate = async event => {
    if (event.candidate) {
      const candidate = event.candidate.toJSON();
      await addDoc(collection(db, `rooms/${roomId}/${isCreator ? 'callerCandidates' : 'calleeCandidates'}`), candidate);
    }
  };

  const roomRef = doc(db, "rooms", roomId);

  async function connect() {
    await startMedia();

    const roomSnapshot = await getDoc(roomRef);

    if (roomSnapshot.exists()) {
      // Joiner
      const data = roomSnapshot.data();
      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await setDoc(roomRef, { answer }, { merge: true });

      onSnapshot(collection(db, `rooms/${roomId}/callerCandidates`), snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") {
            pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
          }
        });
      });

    } else {
      // Creator
      isCreator = true;
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await setDoc(roomRef, { offer });

      onSnapshot(roomRef, async snapshot => {
        const data = snapshot.data();
        if (data?.answer && !pc.currentRemoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
      });

      onSnapshot(collection(db, `rooms/${roomId}/calleeCandidates`), snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") {
            pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
          }
        });
      });
    }
  }

  document.getElementById("endCall").onclick = async () => {
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
    }
    pc.close();

    const callerCandidates = await getDocs(collection(db, `rooms/${roomId}/callerCandidates`));
    const calleeCandidates = await getDocs(collection(db, `rooms/${roomId}/calleeCandidates`));
    await Promise.all([...callerCandidates.docs, ...calleeCandidates.docs].map(d => deleteDoc(d.ref)));
    await deleteDoc(roomRef);
    localStorage.removeItem("roomId");
    location.href = "index.html";
  };

  connect();
</script>
</body>
</html>
