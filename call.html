<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Call</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      background: black;
      height: 100%;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
    }
    #localVideo {
      width: 120px;
      height: 160px;
      bottom: 20px;
      right: 20px;
      border: 2px solid white;
      border-radius: 10px;
      z-index: 2;
    }
    #roomIdDisplay {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      background: rgba(0,0,0,0.5);
      padding: 6px 12px;
      border-radius: 8px;
    }
    #endCall {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #e53935;
      border: none;
      color: white;
      font-size: 24px;
      padding: 16px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 3;
    }
  </style>
</head>
<body>
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay playsinline muted></video>
  <div id="roomIdDisplay"></div>
  <button id="endCall">ðŸ“ž</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCRqfvB5bi8jmxNfu5zhVMcwWR0-YIM8ks",
      authDomain: "video-chat-44584.firebaseapp.com",
      projectId: "video-chat-44584",
      storageBucket: "video-chat-44584.appspot.com",
      messagingSenderId: "598757234224",
      appId: "1:598757234224:web:1ae7b1d35abafeb7d7bff5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const roomIdDisplay = document.getElementById("roomIdDisplay");
    const endCall = document.getElementById("endCall");

    let roomId = localStorage.getItem("roomId") || prompt("Enter Room ID");
    localStorage.setItem("roomId", roomId);
    roomIdDisplay.innerText = "Room ID: " + roomId;

    const pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    pc.onicecandidate = event => {
      if (event.candidate) {
        const candidateRef = ref(db, `rooms/${roomId}/candidates/${isCaller ? 'caller' : 'callee'}`);
        set(candidateRef, { [Date.now()]: event.candidate.toJSON() });
      }
    };

    pc.ontrack = event => {
      remoteVideo.srcObject = event.streams[0];
    };

    let isCaller = false;

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      stream.getTracks().forEach(track => pc.addTrack(track, stream));
      localVideo.srcObject = stream;

      const offerRef = ref(db, `rooms/${roomId}/offer`);
      const answerRef = ref(db, `rooms/${roomId}/answer`);
      const callerCandidatesRef = ref(db, `rooms/${roomId}/candidates/caller`);
      const calleeCandidatesRef = ref(db, `rooms/${roomId}/candidates/callee`);

      onValue(offerRef, async snap => {
        if (snap.exists() && !isCaller) {
          await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          set(answerRef, answer);
        }
      });

      onValue(answerRef, async snap => {
        if (snap.exists() && isCaller) {
          await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
        }
      });

      onValue(callerCandidatesRef, snap => {
        if (!isCaller && snap.exists()) {
          Object.values(snap.val()).forEach(c => {
            pc.addIceCandidate(new RTCIceCandidate(c));
          });
        }
      });

      onValue(calleeCandidatesRef, snap => {
        if (isCaller && snap.exists()) {
          Object.values(snap.val()).forEach(c => {
            pc.addIceCandidate(new RTCIceCandidate(c));
          });
        }
      });

      // Create offer if no offer yet
      onValue(offerRef, async snap => {
        if (!snap.exists()) {
          isCaller = true;
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          set(offerRef, offer);
        }
      });
    });

    endCall.onclick = () => {
      const roomRef = ref(db, `rooms/${roomId}`);
      remove(roomRef);
      localStorage.removeItem("roomId");
      window.location.href = "index.html";
    };
  </script>
</body>
</html>
