<!DOCTYPE html>
<html>
<head>
  <title>Video Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      background-color: #000;
      font-family: Arial, sans-serif;
    }
    #videoContainer {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: black;
    }
    #remoteVideo {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 100vw;
      height: 100vh;
      max-width: 100vw;
      max-height: 100vh;
      object-fit: contain;
      z-index: 1;
      background: black;
      display: block;
    }
    #localVideo {
      position: absolute;
      bottom: 10%;
      right: 10%;
      height: 180px;
      width: auto;
      object-fit: contain;
      border-radius: 12px;
      border: 2px solid #fff;
      z-index: 3;
      background-color: black;
    }
    #endCall {
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      background-color: transparent;
      border: none;
      cursor: pointer;
      z-index: 4;
      width: 70px;
      height: 70px;
      padding: 0;
    }
    #endCall img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    #switchCamera {
      position: absolute;
      bottom: 10%;
      right: 40%;
      z-index: 4;
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #videoQuality {
      position: absolute;
      bottom: 10%;
      left: 40px;
      z-index: 4;
      background: rgba(255,255,255,0.15);
      color: #fff;
      border: none;
      font-size: 16px;
      border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
    }
    #roomIdDisplay {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      background: rgba(0, 0, 0, 0.5);
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 16px;
      z-index: 5;
    }
    @media (max-width: 600px) {
      #localVideo {
        height: 20%;
        width: auto;
        bottom: 15%;
        right: 5%;
      }
      #endCall {
        width: 60px;
        height: 60px;
        bottom: 10%;
      }
      #switchCamera {
        width: 40px;
        height: 40px;
        bottom: 10%;
      }
    }
  </style>
</head>
<body>
  <div id="videoContainer">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
    <button id="endCall"><img src="endcall.png" alt="End Call"></button>
    <button id="switchCamera">&#8645;</button>
    <select id="videoQuality">
      <option value="default">Default</option>
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
    </select>
    <div id="roomIdDisplay"></div>
  </div>
  <script>
    // Simple PeerConnection and Media management example for demo purposes.
    // Replace signaling and server interaction logic with your own as needed.

    let localStream, pc;
    let currentQuality = 'default';
    let currentVideoDeviceId = null;

    const videoQualitySelect = document.getElementById('videoQuality');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    // Helper: get constraints
    function getConstraints(quality, deviceId) {
      let constraints = {
        video: { deviceId: deviceId ? { exact: deviceId } : undefined },
        audio: true
      };
      switch (quality) {
        case 'low':
          constraints.video.width = { max: 320 };
          constraints.video.height = { max: 240 };
          break;
        case 'medium':
          constraints.video.width = { max: 640 };
          constraints.video.height = { max: 480 };
          break;
        case 'high':
          constraints.video.width = { max: 1280 };
          constraints.video.height = { max: 720 };
          break;
      }
      return constraints;
    }

    // Restart local stream and update PeerConnection
    async function restartLocalStream(quality = currentQuality, deviceId = currentVideoDeviceId) {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      let constraints = getConstraints(quality, deviceId);
      try {
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
      } catch (e) {
        try {
          constraints = getConstraints('default', deviceId);
          localStream = await navigator.mediaDevices.getUserMedia(constraints);
          videoQualitySelect.value = 'default';
          currentQuality = 'default';
        } catch (err) {
          alert("Unable to access camera at requested quality.");
          throw err;
        }
      }
      // Handle video track
      const videoTrack = localStream.getVideoTracks()[0];
      const videoSenders = pc.getSenders().filter(sender => sender.track && sender.track.kind === "video");
      if (videoSenders.length && videoTrack) {
        await videoSenders[0].replaceTrack(videoTrack);
      } else if (videoTrack) {
        pc.addTrack(videoTrack, localStream);
      }
      // Handle audio track
      const audioTrack = localStream.getAudioTracks()[0];
      const audioSenders = pc.getSenders().filter(sender => sender.track && sender.track.kind === "audio");
      if (audioSenders.length && audioTrack) {
        await audioSenders[0].replaceTrack(audioTrack);
      } else if (audioTrack) {
        pc.addTrack(audioTrack, localStream);
      }
      localVideo.srcObject = localStream;
    }

    // Switch camera (if multiple)
    document.getElementById('switchCamera').onclick = async () => {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(device => device.kind === 'videoinput');
      if (videoDevices.length > 1) {
        let idx = videoDevices.findIndex(d => d.deviceId === currentVideoDeviceId);
        idx = (idx + 1) % videoDevices.length;
        currentVideoDeviceId = videoDevices[idx].deviceId;
        restartLocalStream(currentQuality, currentVideoDeviceId);
      }
    };

    // Change video quality
    videoQualitySelect.onchange = () => {
      currentQuality = videoQualitySelect.value;
      restartLocalStream(currentQuality, currentVideoDeviceId);
    };

    // Setup PeerConnection
    async function setupConnection() {
      pc = new RTCPeerConnection();
      pc.onicecandidate = event => {
        // Send event.candidate to remote peer via signaling server
      };
      pc.ontrack = event => {
        remoteVideo.srcObject = event.streams[0];
      };
      await restartLocalStream();
      // Add all tracks (video & audio) to PeerConnection
      localStream.getTracks().forEach(track => {
        pc.addTrack(track, localStream);
      });
    }

    // End call button
    document.getElementById('endCall').onclick = () => {
      if (pc) pc.close();
      if (localStream) localStream.getTracks().forEach(track => track.stop());
      remoteVideo.srcObject = null;
      localVideo.srcObject = null;
      alert('Call ended.');
    };

    // Initialize on load
    window.onload = setupConnection;
  </script>
</body>
</html>
